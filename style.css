<script>
  // ============================
  // 強制更新（スマホ用 Ctrl+Shift+R 代替）
  // ============================
  async function hardReloadPWA() {
    // UI的に「押せた感」を出すならここでalertやボタン無効化してもOK
    try {
      // 1) Service Worker 登録を全解除
      if ("serviceWorker" in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }

      // 2) Cache Storage を全削除
      if (window.caches && caches.keys) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }

      // 3) 可能ならストレージ掃除（できる範囲で）
      // localStorage / sessionStorage
      try { localStorage.clear(); } catch(e) {}
      try { sessionStorage.clear(); } catch(e) {}

      // indexedDB（あるなら全削除）
      if (window.indexedDB && indexedDB.databases) {
        try {
          const dbs = await indexedDB.databases();
          await Promise.all((dbs || []).map(db => {
            if (!db.name) return Promise.resolve();
            return new Promise(res => {
              const req = indexedDB.deleteDatabase(db.name);
              req.onsuccess = req.onerror = req.onblocked = () => res();
            });
          }));
        } catch(e) {
          // iOS/Safariはdatabases()が無い場合があるので無視
        }
      }

    } finally {
      // 4) キャッシュバスター付きで再読み込み（これが効く）
      const url = new URL(location.href);
      url.searchParams.set("v", Date.now().toString());
      location.replace(url.toString());
    }
  }

  // ボタンに割り当て
  (function () {
    const btn = document.getElementById("btnHardReload");
    if (!btn) return;
    btn.addEventListener("click", () => {
      // 誤爆防止したいなら confirm をON
      const ok = confirm("Service Workerとキャッシュを消して最新版を取り直します。続行する？");
      if (!ok) return;
      hardReloadPWA();
    });
  })();
</script>
